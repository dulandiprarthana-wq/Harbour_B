<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Manifest Report</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @media print {
            @page {
                size: A4 landscape;
                margin: 0;
            }
            body {
                margin: 0;
                padding: 0;
            }
            .pdf24_page {
                box-shadow: none !important;
                margin: 0 !important;
                page-break-after: always;
            }
        }

        body {
            background-color: #f0f0f0;
            font-family: Verdana, sans-serif;
            font-size: 9px;
            margin: 0;
            padding: 20px;
        }

        .pdf24_page {
            background: white;
            width: 297mm;
            min-height: 210mm;
            margin: 0 auto 20px auto;
            padding: 15mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            box-sizing: border-box;
            position: relative;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .job-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .manifest-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            table-layout: fixed;
        }

        .manifest-table th, .manifest-table td {
            border: 1px solid #000;
            padding: 6px;
            vertical-align: top;
            word-wrap: break-word;
        }

        .manifest-table th {
            background-color: #f5f5f5;
            text-align: left;
            font-weight: bold;
            text-transform: uppercase;
        }

        .total-row {
            font-weight: bold;
            background-color: #fafafa;
        }

        .font-bold { font-weight: bold; }
        .text-right { text-align: right; }
        
        small { font-size: 8px; color: #666; }

        .no-print {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .no-print button {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background 0.2s;
        }

        .no-print button:hover {
            background: #34495e;
        }

        @media print {
            .no-print { display: none !important; }
            body { padding: 0 !important; background: white !important; }
        }
    </style>
</head>
<body>
    <div class="no-print">
        <button onclick="window.print()" style="margin-right: 10px;">Print Report</button>
        <button onclick="downloadManifestAsPDF()" style="background: #27ae60;">Export as PDF</button>
    </div>
    <div id="manifest-main-container">
        <!-- Reports will be injected here -->
    </div>

    <script>
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const hblIds = urlParams.get('hbls');
            if (!hblIds) return;

            const ids = hblIds.split(',');
            
            Promise.all(ids.map(id => 
                fetch('https://harbourb-production.up.railway.app/api/delivery-orders/getDO/' + id).then(r => r.json())
            )).then(results => {
                const mainContainer = document.getElementById('manifest-main-container');
                mainContainer.innerHTML = '';
                
                // Group results by Job ID
                const groups = results.reduce((acc, res) => {
                    if (res.success && res.data) {
                        const d = res.data;
                        const jid = d.jobId?._id || 'unknown';
                        if (!acc[jid]) acc[jid] = [];
                        acc[jid].push(d);
                    }
                    return acc;
                }, {});

                const groupEntries = Object.values(groups);
                const totalPages = Math.ceil(groupEntries.length / 2);

                for (let i = 0; i < groupEntries.length; i += 2) {
                    const currentPage = Math.floor(i / 2) + 1;
                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'pdf24_page';
                    
                    let pageHtml = `
                        <div class="header-info" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #000; padding-bottom: 5px;">
                            <div style="flex: 1;"></div>
                            <div style="flex: 1; text-align: center;">
                                <b style="font-size: 11px;">MANIFEST REPORT</b>
                            </div>
                            <div style="flex: 1; text-align: right;">
                                <b>Page ${currentPage} of ${totalPages}</b>
                            </div>
                        </div>
                    `;

                    const batch = groupEntries.slice(i, i + 2);
                    batch.forEach((groupDocs, batchIdx) => {
                        const firstDO = groupDocs[0];
                        const voyage = firstDO.jobId?.voyage || '';
                        const vessel = firstDO.jobId?.vesselName || '';
                        const mbl = firstDO.jobId?.mblNumber || '';
                        const arrival = firstDO.jobId?.etaDateTime ? new Date(firstDO.jobId.etaDateTime).toLocaleDateString() : '';
                        const pod = firstDO.jobId?.portDischargeName || '';

                        let totalPkgs = 0;
                        const rowsHtml = groupDocs.map((d, index) => {
                            totalPkgs += parseFloat(d.noOfPackages) || 0;
                            const sn = (index + 1).toString().padStart(2, '0');
                            
                            const containersHtml = (d.containerDetails && d.containerDetails.length > 0) 
                                ? d.containerDetails.map(c => {
                                    const parts = [c.containerNo, c.containerType, c.serialNo].filter(p => p && p.toString().trim() !== '');
                                    return parts.join('/');
                                 }).join('<br/>')
                                : (d.containerNo || '');

                            return `
                                <tr>
                                    <td>${sn}</td>
                                    <td>
                                        <b>${d.houseBl || ''}</b><br/>
                                        <small>${d.jobId?.portOfLoadingName || ''}</small>
                                    </td>
                                    <td>
                                        <div style="margin-bottom:8px;">
                                            <b>a] Shipper:</b><br/>
                                            ${d.shipperName || ''}<br/>
                                            ${d.shipperAddress || ''}<br/>
                                            ${d.shipperStreet || ''}<br/>
                                            ${d.shipperCountry || ''}
                                        </div>
                                        <div style="margin-bottom:8px;">
                                            <b>b] Consignee:</b><br/>
                                            ${d.consigneeName || ''}<br/>
                                            ${d.consigneeAddress || ''}<br/>
                                            ${d.consigneeStreet || ''}<br/>
                                            ${d.consigneeCountry || ''}
                                        </div>
                                        <div>
                                            <b>c] Notify:</b><br/>
                                            ${d.notifyPartyName || ''}<br/>
                                            ${d.notifyPartyAddress || ''}<br/>
                                            ${d.notifyPartyStreet || ''}<br/>
                                            ${d.notifyPartyCountry || ''}
                                        </div>
                                    </td>
                                    <td>${d.description || ''}</td>
                                    <td style="word-break:break-all;">${d.marksNumbers || ''}</td>
                                    <td>${containersHtml}</td>
                                    <td>${d.packageTypeName || ''}<br/><b>${d.noOfPackages || ''}</b></td>
                                    <td>${d.grossWeight || ''}<br/><small>KGS</small></td>
                                    <td>${d.cbm || ''}<br/><small>CBM</small></td>
                                </tr>
                            `;
                        }).join('');

                        pageHtml += `
                            <div class="manifest-group" style="${batchIdx === 0 && batch.length > 1 ? 'margin-bottom: 30px; border-bottom: 2px dashed #eee; padding-bottom: 20px;' : ''}">
                                <div class="job-details" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                    <div style="flex: 1; font-size: 9px; line-height: 1.3;">
                                        <b>HARBOUR LINES (PVT) LTD.,</b><br/>
                                        No. 94/1, Lauries Road<br/>
                                        COLOMBO 04,, SRI LANKA.<br/>
                                        TEL. TEL : +94 11 4360210 / 0772384591
                                    </div>
                                    <div style="flex: 1; text-align: left; padding-left: 20px;">
                                        <div><b>Voyage:</b> ${voyage}</div>
                                        <div><b>Vessel:</b> ${vessel}</div>
                                        <div><b>MBL No:</b> ${mbl}</div>
                                    </div>
                                    <div style="flex: 1; text-align: right;">
                                        <div><b>Arrival:</b> ${arrival}</div>
                                        <div><b>Port of Discharge:</b> ${pod}</div>
                                    </div>
                                </div>

                                <table class="manifest-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 3%;">S/N</th>
                                            <th style="width: 10%;">HBL / POL</th>
                                            <th style="width: 24%;">Parties (Shipper/Consignee/Notify)</th>
                                            <th style="width: 26%;">Description</th>
                                            <th style="width: 8%;">Marks & Nos.</th>
                                            <th style="width: 12%;">Containers</th>
                                            <th style="width: 7%;">Pkgs</th>
                                            <th style="width: 5%;">Weight</th>
                                            <th style="width: 5%;">Measure</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${rowsHtml}
                                    </tbody>
                                    <tfoot>
                                        <tr class="total-row">
                                            <td colspan="6" class="text-right">Total Packages</td>
                                            <td colspan="3">${totalPkgs}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        `;
                    });

                    pageDiv.innerHTML = pageHtml;
                    mainContainer.appendChild(pageDiv);
                }

                // Auto print or download if requested
                const download = urlParams.get('download');
                if (download === 'true') {
                    setTimeout(() => {
                        downloadManifestAsPDF();
                    }, 1000);
                }
            });
        };

        function downloadManifestAsPDF() {
            const element = document.getElementById('manifest-main-container');
            const opt = {
                margin: 0,
                filename: 'Manifest_Report.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };
            
            // Temporary hide print buttons if they exist in the element
            html2pdf().set(opt).from(element).save();
        }
    </script>
</body>
</html>
